<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Koloau | Material Professional</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            /* M3 Color System Mapping from Telegram */
            --md-sys-color-primary: var(--tg-theme-button-color, #6750a4);
            --md-sys-color-on-primary: var(--tg-theme-button-text-color, #ffffff);
            --md-sys-color-surface: var(--tg-theme-bg-color, #fdf7ff);
            --md-sys-color-on-surface: var(--tg-theme-text-color, #1d1b20);
            --md-sys-color-surface-container: var(--tg-theme-secondary-bg-color, #f3edf7);
            --md-sys-color-secondary-container: var(--tg-theme-secondary-bg-color, #e8def8);
            --md-sys-color-on-secondary-container: var(--tg-theme-text-color, #1d192b);
            --md-sys-color-outline: var(--tg-theme-hint-color, #79747e);
            --md-sys-color-outline-variant: rgba(121, 116, 126, 0.2);
        }

        body {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Material 3 Top App Bar */
        .m3-top-app-bar {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            background-color: var(--md-sys-color-surface);
            font-size: 1.4rem;
            font-weight: 500;
        }

        .m3-top-app-bar .title {
            flex: 1;
            font-weight: 500;
            letter-spacing: -0.5px;
        }

        /* Main Content Wrapper */
        .m3-content {
            flex: 1;
            padding: 0 16px 100px 16px; /* Extra bottom padding for nav bar */
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Material 3 Card */
        .m3-card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .m3-card-title {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--md-sys-color-primary);
            text-transform: uppercase;
            letter-spacing: 0.1px;
        }

        /* M3 Input Fields */
        .m3-text-field {
            margin-bottom: 16px;
        }

        .m3-text-field label {
            display: block;
            font-size: 0.75rem;
            margin-bottom: 4px;
            margin-left: 4px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
        }

        .m3-text-field input, .m3-text-field textarea {
            width: 100%;
            background-color: var(--md-sys-color-secondary-container);
            border: none;
            border-bottom: 2px solid var(--md-sys-color-outline);
            border-radius: 8px 8px 0 0;
            padding: 12px 16px;
            color: var(--md-sys-color-on-surface);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-bottom-color 0.2s;
        }

        .m3-text-field input:focus, .m3-text-field textarea:focus {
            outline: none;
            border-bottom-color: var(--md-sys-color-primary);
        }

        /* M3 Buttons */
        .m3-button-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: 100px;
            height: 48px;
            padding: 0 24px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }

        .m3-button-filled:active { opacity: 0.8; }

        /* M3 Navigation Bar (Bottom) */
        .m3-navigation-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background-color: var(--md-sys-color-surface-container);
            display: flex;
            justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            border-top: 1px solid var(--md-sys-color-outline-variant);
            z-index: 100;
        }

        .m3-navigation-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            gap: 4px;
            color: var(--md-sys-color-on-surface);
        }

        .m3-navigation-item .icon-container {
            width: 64px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .m3-navigation-item.active .icon-container {
            background-color: var(--md-sys-color-secondary-container);
        }

        .m3-navigation-item svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .m3-navigation-item .label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Chat Specifics */
        .m3-chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 164px); /* Top bar + Nav bar + buffers */
        }

        .m3-chat-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px 0;
        }

        .m3-msg-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .m3-msg-bubble.user {
            align-self: flex-end;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .m3-msg-bubble.ai {
            align-self: flex-start;
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .m3-chat-input-row {
            padding: 8px 0;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .m3-chat-input-pill {
            flex: 1;
            background-color: var(--md-sys-color-surface-container);
            border-radius: 28px;
            display: flex;
            align-items: center;
            padding: 4px 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .m3-chat-input-pill input {
            background: transparent !important;
            border: none !important;
            height: 40px;
            font-size: 1rem;
            color: var(--md-sys-color-on-surface);
            width: 100%;
            outline: none;
        }

        .m3-icon-button {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--md-sys-color-primary);
            cursor: pointer;
        }

        .m3-icon-button.recording { color: #b3261e; animation: m3-pulse 1s infinite alternate; }
        @keyframes m3-pulse { from { opacity: 1; } to { opacity: 0.5; } }

        /* Chips */
        .m3-chip-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
            scrollbar-width: none;
        }
        .m3-chip-row::-webkit-scrollbar { display: none; }

        .m3-chip {
            padding: 6px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .m3-chip.active {
            background-color: var(--md-sys-color-secondary-container);
            border-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .hidden { display: none; }
    </style>
  </head>
  <body>
    <header class="m3-top-app-bar">
      <span class="title">Koloau Studio</span>
      <div id="status-ind" style="width: 8px; height: 8px; border-radius: 4px; background: #2ecc71;"></div>
    </header>

    <main class="m3-content">
      <!-- Chat Tab -->
      <div id="tab-studio" class="tab-pane">
        <div class="m3-chip-row" id="chat-models"></div>
        <div class="m3-chat-container">
          <div class="m3-chat-messages" id="messages-log">
            <div class="m3-msg-bubble ai">Привет. Это Koloau 3.1. Выберите модель и начните диалог. Нажмите на микрофон для записи голоса.</div>
          </div>
          <div class="m3-chat-input-row">
            <div class="m3-chat-input-pill">
              <input type="text" id="chat-msg-input" placeholder="Сообщение" onkeypress="handleEnter(event)">
              <button class="m3-icon-button" id="mic-btn" onclick="runVoice()">
                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
              </button>
            </div>
            <button class="m3-icon-button" style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);" onclick="pushMsg()">
              <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Factory Tab -->
      <div id="tab-factory" class="tab-pane hidden">
        <div class="m3-card">
          <div class="m3-card-title">Создание Бота</div>
          <div class="m3-text-field">
            <label>TOKEN @BotFather</label>
            <input type="text" id="bot-token-input" placeholder="Перенесите токен сюда">
          </div>
          <div class="m3-card-title" style="margin-top: 24px;">Двигатель Бота</div>
          <div class="m3-chip-row" id="builder-models"></div>
          <input type="hidden" id="selected-builder-id" value="gpt-5.2-pro">
          <div class="m3-text-field" style="margin-top: 16px;">
            <label>РОЛЬ И ИНСТРУКЦИИ</label>
            <textarea id="bot-role-input" style="height: 100px;" placeholder="Опишите поведение бота"></textarea>
          </div>
          <button class="m3-button-filled" onclick="deployBot()">
            <svg viewBox="0 0 24 24" width="20"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            Активировать
          </button>
        </div>

        <div class="m3-card-title">Ваш Флот</div>
        <div id="fleet-registry"></div>
      </div>
    </main>

    <nav class="m3-navigation-bar">
      <div class="m3-navigation-item active" onclick="navTo('studio', this)">
        <div class="icon-container">
          <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
        </div>
        <span class="label">Студия</span>
      </div>
      <div class="m3-navigation-item" onclick="navTo('factory', this)">
        <div class="icon-container">
          <svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.3 4.3C.2 6.7.6 9.7 2.6 11.7c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 .1-1.4z"/></svg>
        </div>
        <span class="label">Завод</span>
      </div>
    </nav>

    <script>
      const twa = window.Telegram.WebApp;
      twa.expand();
      twa.ready();

      let models = {};
      let studioModel = 'gpt-5.2-pro';
      let factoryModel = 'gpt-5.2-pro';
      let history = [];
      let isMicActive = false;
      const speech = ('webkitSpeechRecognition' in window) ? new webkitSpeechRecognition() : null;

      if (speech) {
        speech.continuous = false;
        speech.lang = 'ru-RU';
        speech.onresult = (e) => {
          document.getElementById('chat-msg-input').value = e.results[0][0].transcript;
          toggleMic(false);
        };
        speech.onend = () => toggleMic(false);
      }

      async function start() {
        const r = await fetch('/api/models');
        models = await r.json();
        drawModels();
        syncFleet();
        fixTheme();
      }

      function fixTheme() {
        // Force M3 palette refresh based on TWA params
        const root = document.documentElement;
        root.style.setProperty('--md-sys-color-surface', twa.backgroundColor);
        root.style.setProperty('--md-sys-color-on-surface', twa.textColor);
      }

      function navTo(tab, el) {
        if (twa.HapticFeedback) twa.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        document.querySelectorAll('.m3-navigation-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        twa.backgroundColor = tab === 'studio' ? twa.themeParams.bg_color : twa.themeParams.secondary_bg_color;
      }

      function drawModels() {
        const sc1 = document.getElementById('chat-models');
        const sc2 = document.getElementById('builder-models');
        let html = '';
        Object.keys(models).forEach(k => {
          Object.keys(models[k].models).forEach(id => {
            html += `<div class="m3-chip ${studioModel === id ? 'active' : ''}" data-id="${id}" onclick="pickModel('${id}', this)">${models[k].models[id]}</div>`;
          });
        });
        sc1.innerHTML = html;
        sc2.innerHTML = html;
      }

      function pickModel(id, el) {
        if (twa.HapticFeedback) twa.HapticFeedback.selectionChanged();
        const p = el.parentElement;
        p.querySelectorAll('.m3-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        if (p.id.includes('chat')) studioModel = id;
        else {
          factoryModel = id;
          document.getElementById('selected-builder-id').value = id;
        }
      }

      function runVoice() {
        if (!speech) return twa.showAlert('Голос не работает в этом браузере');
        toggleMic(!isMicActive);
      }

      function toggleMic(active) {
        isMicActive = active;
        const btn = document.getElementById('mic-btn');
        if (active) {
          btn.classList.add('recording');
          speech.start();
        } else {
          btn.classList.remove('recording');
          try { speech.stop(); } catch(e) {}
        }
      }

      function handleEnter(e) { if(e.key === 'Enter') pushMsg(); }

      async function pushMsg() {
        const inp = document.getElementById('chat-msg-input');
        const val = inp.value.trim();
        if (!val) return;
        if (twa.HapticFeedback) twa.HapticFeedback.impactOccurred('medium');
        renderMsg('user', val);
        inp.value = '';
        try {
          const r = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ message: val, model: studioModel, chatHistory: history })
          });
          const d = await r.json();
          if (d.success) {
            renderMsg('ai', d.response);
            history.push({role:'user', content:val}, {role:'assistant', content:d.response});
          }
        } catch(e) { renderMsg('ai', 'Ошибка сети.'); }
      }

      function renderMsg(role, text) {
        const log = document.getElementById('messages-log');
        const d = document.createElement('div');
        d.className = `m3-msg-bubble ${role}`;
        d.innerText = text;
        log.appendChild(d);
        log.scrollTop = log.scrollHeight;
      }

      async function deployBot() {
        const t = document.getElementById('bot-token-input').value;
        const r = document.getElementById('bot-role-input').value;
        if (!t || !r) return twa.showAlert('Заполните токен и описание');
        if (twa.HapticFeedback) twa.HapticFeedback.notificationOccurred('success');
        const res = await fetch('/api/bots/create', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ token: t, model: factoryModel, instructions: r })
        });
        const d = await res.json();
        if (d.success) {
          twa.showAlert('Агент запущен!');
          syncFleet();
        } else twa.showAlert('Ошибка: ' + d.message);
      }

      async function syncFleet() {
        const r = await fetch('/api/bots/list');
        const d = await r.json();
        const registry = document.getElementById('fleet-registry');
        registry.innerHTML = d.bots.map(b => `
          <div class="m3-card" style="padding: 12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:700; font-size: 0.9rem;">${b.token.substring(0, 12)}...</span>
              <span style="font-size: 0.7rem; color: ${b.is_active ? '#388e3c' : '#d32f2f'}; font-weight:700;">${b.is_active ? 'ON' : 'OFF'}</span>
            </div>
            <div style="font-size: 0.75rem; margin-top: 4px; opacity: 0.7;">CPU: ${b.model}</div>
            <div style="display:flex; gap: 8px; margin-top: 12px;">
              <button class="m3-button-filled" style="padding:0 12px; height: 32px; font-size: 0.75rem;" onclick="flipBot('${b.token}')">${b.is_active ? 'Пауза' : 'Пуск'}</button>
              <button class="m3-button-filled" style="padding:0 12px; height: 32px; font-size: 0.75rem; background:#f44336;" onclick="killBot('${b.token}')">Удалить</button>
            </div>
          </div>
        `).join('');
      }

      async function flipBot(t) { await fetch('/api/bots/toggle', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:t})}); syncFleet(); }
      async function killBot(t) { if(confirm('Удалить?')) { await fetch('/api/bots/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:t})}); syncFleet(); } }

      start();
    </script>
  </body>
</html>
