<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Koloau | AI Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
        .dashboard-section { margin-top: 40px; }
        .bot-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .bot-card { padding: 20px; border-radius: 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .bot-card h3 { font-size: 1rem; margin-bottom: 10px; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bot-card .status { font-size: 0.8rem; padding: 4px 8px; border-radius: 10px; background: #2ecc71; color: #fff; }
        .bot-card .model-tag { font-size: 0.8rem; opacity: 0.7; margin-left: 10px; }
        .bot-card .actions { margin-top: 15px; display: flex; gap: 10px; }
        .btn-small { padding: 8px 12px; font-size: 0.8rem; cursor: pointer; border-radius: 8px; border: none; transition: 0.3s; }
        .btn-stop { background: #e74c3c; color: white; }
        .btn-stop:hover { background: #c0392b; }
        .model-select-group { display: flex; flex-direction: column; gap: 10px; }
        .category-tabs { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 8px 15px; background: rgba(255, 255, 255, 0.1); border-radius: 20px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; border: 1px solid transparent; }
        .tab-btn.active { background: #fff; color: #000; }
        #model-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .model-opt { padding: 10px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); font-size: 0.8rem; cursor: pointer; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); transition: 0.2s; }
        .model-opt:hover { background: rgba(255, 255, 255, 0.1); }
        .model-opt.selected { border-color: #fff; background: rgba(255, 255, 255, 0.2); }
    </style>
  </head>
  <body>
    <div class="background-blobs">
      <div class="blob blob-1"></div>
      <div class="blob blob-2"></div>
      <div class="blob blob-3"></div>
    </div>

    <div class="container">
      <header>
        <div class="logo">Koloau</div>
        <h1>–£–ø—Ä–∞–≤–ª—è–π —Å–≤–æ–∏–º AI-—Ñ–ª–æ—Ç–æ–º</h1>
        <p>–°–æ–∑–¥–∞–≤–∞–π, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π –¥–µ—Å—è—Ç–∫–∏ –±–æ—Ç–æ–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.</p>
      </header>

      <main>
        <form id="bot-form" class="glass-card">
          <div class="input-group">
            <label for="token">Telegram Bot Token</label>
            <input type="text" id="token" placeholder="123456789:ABCDE..." required />
          </div>

          <div class="input-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–π—Ä–æ—Å–µ—Ç—å</label>
            <div class="model-select-group">
                <div class="category-tabs" id="category-tabs"></div>
                <div id="model-list"></div>
                <input type="hidden" id="model-input" value="gpt-4o-mini" />
            </div>
          </div>

          <div class="input-group">
            <label for="instructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (System Prompt)</label>
            <textarea id="instructions" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –∫–æ–¥–∏–Ω–≥–µ..." required></textarea>
          </div>

          <button type="submit" id="submit-btn" class="main-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ë–æ—Ç–∞</button>
          <div id="status"></div>
        </form>

        <section class="dashboard-section">
            <h2>üåç –ú–æ–∏ –ê–∫—Ç–∏–≤–Ω—ã–µ –ë–æ—Ç—ã</h2>
            <div id="bot-list" class="bot-list">
                <!-- Dynamic Content -->
                <div class="glass-card" style="text-align:center; padding: 40px; opacity:0.5">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–∏—Ö –±–æ—Ç–æ–≤...</div>
            </div>
        </section>
      </main>

      <footer>
        <p>&copy; 2026 Koloau AI. Powered by F5AI SDK.</p>
      </footer>
    </div>

    <script>
      let modelsData = {};
      let selectedModel = 'gpt-4o-mini';

      async function loadModels() {
          const res = await fetch('/api/models');
          modelsData = await res.json();
          renderTabs();
          renderModels('openai');
      }

      function renderTabs() {
          const container = document.getElementById('category-tabs');
          container.innerHTML = Object.keys(modelsData).map((cat, i) => `
              <div class="tab-btn ${i === 0 ? 'active' : ''}" onclick="selectCategory('${cat}', this)">${modelsData[cat].label}</div>
          `).join('');
      }

      function selectCategory(cat, btn) {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderModels(cat);
      }

      function renderModels(cat) {
          const container = document.getElementById('model-list');
          container.innerHTML = Object.keys(modelsData[cat].models).map(id => `
              <div class="model-opt ${selectedModel === id ? 'selected' : ''}" onclick="selectModel('${id}', this)">
                  ${modelsData[cat].models[id]}
              </div>
          `).join('');
      }

      function selectModel(id, el) {
          selectedModel = id;
          document.getElementById('model-input').value = id;
          document.querySelectorAll('.model-opt').forEach(o => o.classList.remove('selected'));
          el.classList.add('selected');
      }

      async function fetchBots() {
          const res = await fetch('/api/bots/list');
          const data = await res.json();
          const container = document.getElementById('bot-list');
          
          if (data.bots.length === 0) {
              container.innerHTML = '<div class="glass-card" style="text-align:center; padding: 40px; opacity:0.5">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤.</div>';
              return;
          }

          container.innerHTML = data.bots.map(b => `
              <div class="bot-card glass-card">
                  <h3>${b.token.substring(0, 15)}...</h3>
                  <div>
                      <span class="status">${b.status}</span>
                      <span class="model-tag">${b.model}</span>
                  </div>
                  <div class="actions">
                      <button class="btn-small btn-stop" onclick="stopBot('${b.token}')">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                      <button class="btn-small" onclick="window.open('https://t.me/${b.token.split(':')[0]}', '_blank')">–û—Ç–∫—Ä—ã—Ç—å TG</button>
                  </div>
              </div>
          `).join('');
      }

      async function stopBot(token) {
          if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –±–æ—Ç–∞?')) return;
          const res = await fetch('/api/bots/stop', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token })
          });
          const result = await res.json();
          if (result.success) fetchBots();
      }

      document.getElementById("bot-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = document.getElementById("submit-btn");
          const status = document.getElementById("status");

          const data = {
            token: document.getElementById("token").value,
            model: selectedModel,
            instructions: document.getElementById("instructions").value,
          };

          btn.disabled = true;
          btn.innerText = "–ó–∞–ø—É—Å–∫...";

          try {
            const response = await fetch("/api/bots/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            if (result.success) {
                status.innerHTML = `<span class="success">–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!</span>`;
                fetchBots();
                document.getElementById("bot-form").reset();
            } else {
                status.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${result.message}</span>`;
            }
          } catch (err) {
            status.innerHTML = `<span class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>`;
          } finally {
            btn.disabled = false;
            btn.innerText = "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ë–æ—Ç–∞";
          }
        });

      loadModels();
      fetchBots();
    </script>
  </body>
</html>
