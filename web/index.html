<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Koloau | AI Studio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #0f172a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #94a3b8);
            --tg-accent: var(--tg-theme-button-color, #6366f1);
            --tg-accent-text: var(--tg-theme-button-text-color, #ffffff);
            
            /* Glassmorphism Defaults (Dark) */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --input-bg: rgba(0, 0, 0, 0.3);
            --ai-bubble: rgba(255, 255, 255, 0.05);
            --shadow: rgba(0, 0, 0, 0.3);
        }

        /* Light Theme Override */
        body.light-theme {
            --tg-bg: #f3f4f6;
            --tg-text: #1f2937;
            --tg-hint: #6b7280;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.08);
            --input-bg: rgba(255, 255, 255, 1);
            --ai-bubble: #ffffff;
            --shadow: rgba(0, 0, 0, 0.05);
        }

        body {
            background: var(--tg-bg);
            color: var(--tg-text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
            transition: 0.3s all cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-box {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px var(--shadow);
        }

        h2 { font-size: 1.1rem; font-weight: 900; color: var(--tg-text); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1.5px; }
        label { color: var(--tg-hint); font-size: 0.8rem; font-weight: 800; margin-bottom: 8px; display: block; }
        
        input, textarea, select {
            background: var(--input-bg) !important;
            border: 1px solid var(--glass-border) !important;
            color: var(--tg-text) !important;
            font-size: 1rem !important;
            padding: 14px 18px !important;
            border-radius: 14px !important;
            width: 100%;
            transition: 0.3s;
        }

        input:focus { border-color: var(--tg-accent) !important; }

        .main-btn {
            background: var(--tg-accent);
            color: var(--tg-accent-text);
            padding: 16px;
            border-radius: 16px;
            font-weight: 900;
            text-transform: uppercase;
            border: none;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(var(--tg-theme-button-color-rgb, 99, 102, 241), 0.3);
            transition: 0.3s;
        }

        .main-btn:active { transform: scale(0.98); opacity: 0.9; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 75px;
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            opacity: 0.4;
            transition: 0.3s;
        }

        .nav-tab.active { opacity: 1; color: var(--tg-accent); }
        .nav-tab span { font-size: 1.4rem; }
        .nav-tab label { font-size: 0.7rem; color: inherit; margin: 0; cursor: pointer; }

        .mode-container { display: none; padding: 15px; animation: fadeIn 0.4s ease-out; }
        .mode-container.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Chat UI Refinement */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 160px); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { padding: 14px 18px; border-radius: 20px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; box-shadow: 0 2px 10px var(--shadow); }
        .bubble.user { align-self: flex-end; background: var(--tg-accent); color: var(--tg-accent-text); border-bottom-right-radius: 4px; }
        .bubble.ai { align-self: flex-start; background: var(--ai-bubble); border: 1px solid var(--glass-border); color: var(--tg-text); border-bottom-left-radius: 4px; }
        
        .chat-input-area { display: flex; gap: 12px; padding: 12px; background: var(--input-bg); border-radius: 24px; align-items: center; border: 1px solid var(--glass-border); }
        .chat-input { flex-grow: 1; height: 40px !important; border: none !important; background: transparent !important; padding: 0 !important; }

        /* Chips */
        .model-scroller { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0 20px 0; scrollbar-width: none; }
        .m-chip { padding: 10px 20px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 15px; white-space: nowrap; font-size: 0.85rem; font-weight: 700; transition: 0.2s; box-shadow: 0 4px 10px var(--shadow); }
        .m-chip.active { background: var(--tg-accent); color: var(--tg-accent-text); border-color: var(--tg-accent); }

        /* Utility */
        .btn-icon { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--glass-bg); border: 1px solid var(--glass-border); cursor: pointer; }
        .bot-card-mini { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: 0 5px 15px var(--shadow); }

    </style>
  </head>
  <body>
    <!-- Premium Header -->
    <header style="padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px);">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div id="status-dot" style="width: 12px; height: 12px; border-radius: 50%; background: #2ecc71; border: 3px solid var(--tg-bg);"></div>
            <span style="font-weight: 900; font-size: 1.3rem; letter-spacing: -1.5px;">KOLOAU <span style="color:var(--tg-accent)">MAX</span></span>
        </div>
        <div class="btn-icon" onclick="toggleLocalTheme()">
            <span id="theme-icon">‚ú®</span>
        </div>
    </header>

    <!-- Mode 1: STUDIO -->
    <div id="mode-studio" class="mode-container active">
        <label style="margin-left: 5px;">–í–´–ë–ï–†–ò –ú–û–ó–ì</label>
        <div class="model-scroller" id="model-scroller-chat"></div>

        <div class="chat-container glass-box">
            <div class="chat-messages" id="chat-messages">
                <div class="bubble ai">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Koloau 2.7. –Ø –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ –≤ –ª—é–±–æ–π —Ç–µ–º–µ. –í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –∏ –Ω–∞—á–Ω–µ–º! üîã</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatKey(event)">
                <button class="main-btn" onclick="sendChatMessage()" style="width: 44px; height: 44px; padding: 0; margin: 0; border-radius: 50%;">‚úàÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- Mode 2: FACTORY -->
    <div id="mode-factory" class="mode-container">
        <section class="glass-box">
            <h2>üõ† –°–û–ó–î–ê–ù–ò–ï –ê–ì–ï–ù–¢–ê</h2>
            <div class="input-group">
                <label>TOKEN (@BOTFATHER)</label>
                <input type="text" id="token" placeholder="12345:AAAA...">
            </div>
            <div class="input-group">
                <label>–î–í–ò–ñ–û–ö</label>
                <div class="model-scroller" id="model-scroller-builder"></div>
                <input type="hidden" id="builder-model" value="gpt-5.2-pro">
            </div>
            <div class="input-group">
                <label>–ò–ù–°–¢–†–£–ö–¶–ò–ò (SYSTEM PROMPT)</label>
                <textarea id="instructions" style="height: 100px;" placeholder="–¢–≤–æ–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞..."></textarea>
            </div>
            <button class="main-btn" onclick="createBot()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
        </section>

        <section id="fleet-section">
            <h2 style="padding-left: 5px;">üîã –ê–ö–¢–ò–í–ù–´–ô –§–õ–û–¢</h2>
            <div id="bot-list"></div>
        </section>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-tab active" onclick="switchMode('studio', this)">
            <span>‚ö°Ô∏è</span>
            <label>–°—Ç—É–¥–∏—è</label>
        </div>
        <div class="nav-tab" onclick="switchMode('factory', this)">
            <span>ü¶æ</span>
            <label>–ó–∞–≤–æ–¥</label>
        </div>
    </nav>

    <script>
      const tg = window.Telegram.WebApp;
      tg.expand();
      tg.ready();

      let modelsData = {};
      let selectedChatModel = 'gpt-5.2-pro';
      let selectedBuilderModel = 'gpt-5.2-pro';
      let chatHistory = [];
      let isLocalLightTheme = false;

      // Theme logic
      function updateTheme(isLight) {
          if (isLight) {
              document.body.classList.add('light-theme');
              document.getElementById('theme-icon').innerText = 'üåô';
              tg.setHeaderColor('#f3f4f6');
          } else {
              document.body.classList.remove('light-theme');
              document.getElementById('theme-icon').innerText = '‚ú®';
              tg.setHeaderColor(tg.themeParams.bg_color || '#0f172a');
          }
      }

      function toggleLocalTheme() {
          if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
          isLocalLightTheme = !isLocalLightTheme;
          updateTheme(isLocalLightTheme);
      }

      // Initial theme sync
      if (tg.colorScheme === 'light') {
          isLocalLightTheme = true;
          updateTheme(true);
      }

      async function init() {
          const res = await fetch('/api/models');
          modelsData = await res.json();
          renderModelScrollers();
          fetchBots();
      }

      function switchMode(mode, el) {
          if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
          document.querySelectorAll('.mode-container').forEach(m => m.classList.remove('active'));
          document.getElementById(`mode-${mode}`).classList.add('active');
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          el.classList.add('active');
      }

      function renderModelScrollers() {
          const chatScroller = document.getElementById('model-scroller-chat');
          const buildScroller = document.getElementById('model-scroller-builder');
          let html = '';
          Object.keys(modelsData).forEach(cat => {
              Object.keys(modelsData[cat].models).forEach(id => {
                  html += `<div class="m-chip ${selectedChatModel === id ? 'active' : ''}" data-id="${id}" onclick="selectModel('${id}', this)">${modelsData[cat].models[id]}</div>`;
              });
          });
          chatScroller.innerHTML = html;
          buildScroller.innerHTML = html;
      }

      function selectModel(id, el) {
          if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
          const parent = el.parentElement;
          parent.querySelectorAll('.m-chip').forEach(c => c.classList.remove('active'));
          el.classList.add('active');
          if (parent.id === 'model-scroller-chat') selectedChatModel = id;
          else {
              selectedBuilderModel = id;
              document.getElementById('builder-model').value = id;
          }
      }

      function handleChatKey(e) { if(e.key === 'Enter') sendChatMessage(); }

      async function sendChatMessage() {
          const input = document.getElementById('chat-input');
          const msg = input.value.trim();
          if (!msg) return;
          if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
          appendMessage('user', msg);
          input.value = '';
          try {
              const res = await fetch('/api/chat', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ message: msg, model: selectedChatModel, chatHistory })
              });
              const data = await res.json();
              if (data.success) {
                  appendMessage('ai', data.response);
                  chatHistory.push({ role: 'user', content: msg }, { role: 'assistant', content: data.response });
              } else appendMessage('ai', '–û—à–∏–±–∫–∞ –¥–≤–∏–∂–∫–∞: ' + data.message);
          } catch(e) { appendMessage('ai', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.'); }
      }

      function appendMessage(role, text) {
          const container = document.getElementById('chat-messages');
          const div = document.createElement('div');
          div.className = `bubble ${role}`;
          div.innerText = text;
          container.appendChild(div);
          container.scrollTop = container.scrollHeight;
      }

      async function createBot() {
          const token = document.getElementById('token').value;
          const instructions = document.getElementById('instructions').value;
          if (!token || !instructions) return tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!');
          if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
          try {
            const res = await fetch("/api/bots/create", { 
                method: "POST", headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify({ token, model: selectedBuilderModel, instructions }) 
            });
            const result = await res.json();
            if (result.success) {
                tg.showAlert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤–æ —Ñ–ª–æ—Ç–µ!');
                fetchBots();
            } else tg.showAlert('–û—à–∏–±–∫–∞: ' + result.message);
          } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); }
      }

      async function fetchBots() {
          const res = await fetch('/api/bots/list');
          const data = await res.json();
          const container = document.getElementById('bot-list');
          if (data.bots.length === 0) {
              container.innerHTML = '<div style="opacity:0.3; text-align:center; padding: 20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤.</div>';
              return;
          }
          container.innerHTML = data.bots.map(b => `
              <div class="bot-card-mini">
                  <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <div style="font-weight: 800; font-size: 0.9rem;">${b.token.substring(0, 12)}...</div>
                        <div style="opacity:0.5; font-size: 0.6rem;">Model: ${b.model}</div>
                    </div>
                    <span class="badge" style="background: ${b.is_active ? '#2ecc71' : '#ff4757'}; color:#fff; padding: 4px 10px; border-radius: 10px;">${b.is_active ? 'LIVE' : 'OFF'}</span>
                  </div>
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <button class="main-btn" style="padding: 10px; font-size: 0.7rem;" onclick="toggleBot('${b.token}')">${b.is_active ? '‚è∏ –ü–ê–£–ó–ê' : '‚ñ∂Ô∏è –ü–£–°–ö'}</button>
                    <button class="main-btn" style="padding: 10px; font-size: 0.7rem; background: rgba(231, 76, 60, 0.1); color: #e74c3c; box-shadow:none;" onclick="deleteBot('${b.token}')">üóë –£–î–ê–õ–ò–¢–¨</button>
                  </div>
              </div>
          `).join('');
      }

      async function toggleBot(token) {
          if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
          await fetch('/api/bots/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) });
          fetchBots();
      }

      async function deleteBot(token) {
          if (tg.showConfirm && await new Promise(r => tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –±–æ—Ç–µ?', r))) {
              if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
              await fetch('/api/bots/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) });
              fetchBots();
          }
      }

      init();
    </script>
  </body>
</html>
