<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Koloau | AI Studio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #0f172a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #94a3b8);
            --tg-accent: var(--tg-theme-button-color, #6366f1);
            --tg-accent-text: var(--tg-theme-button-text-color, #ffffff);
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.15);
        }

        body {
            background: var(--tg-bg);
            color: var(--tg-text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* Space for bottom nav */
            -webkit-user-select: none;
            user-select: none;
        }

        /* High Contrast & Glassmorphism */
        .glass-box {
            background: var(--glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }

        h2 { font-size: 1.1rem; font-weight: 900; color: var(--tg-text); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        label { color: var(--tg-hint); font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; display: block; }
        
        input, textarea, select {
            background: rgba(0,0,0,0.2) !important;
            border: 1px solid var(--border) !important;
            color: var(--tg-text) !important;
            font-size: 1rem !important;
            padding: 12px 15px !important;
            border-radius: 12px !important;
            width: 100%;
            box-sizing: border-box;
        }

        .main-btn {
            background: var(--tg-accent);
            color: var(--tg-accent-text);
            padding: 15px;
            border-radius: 15px;
            font-weight: 900;
            text-transform: uppercase;
            border: none;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* Tab Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(var(--tg-theme-bg-color-rgb, 15, 23, 42), 0.8);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            opacity: 0.4;
            transition: 0.3s;
            cursor: pointer;
            flex: 1;
        }

        .nav-tab.active { opacity: 1; color: var(--tg-accent); }
        .nav-tab span { font-size: 1.5rem; }
        .nav-tab label { font-size: 0.65rem; color: inherit; cursor: pointer; margin: 0; }

        /* Modes */
        .mode-container { display: none; padding: 15px; animation: fadeIn 0.3s forwards; }
        .mode-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AI Studio (Chat) Mode */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 120px); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 12px 16px; border-radius: 18px; max-width: 85%; line-height: 1.4; font-size: 0.95rem; }
        .bubble.user { align-self: flex-end; background: var(--tg-accent); color: var(--tg-accent-text); }
        .bubble.ai { align-self: flex-start; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--tg-text); }
        
        .chat-input-area { display: flex; gap: 10px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 20px; align-items: center; }
        .chat-input { flex-grow: 1; height: 45px !important; border: none !important; background: transparent !important; }

        /* Bot Cards Tooling */
        .bot-card-mini { background: var(--glass); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 10px; }
        .badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 20px; font-weight: 800; }
        
        /* Model Selection Horizontal */
        .model-scroller { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .m-chip { padding: 10px 18px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; white-space: nowrap; font-size: 0.85rem; font-weight: 600; }
        .m-chip.active { background: #fff; color: #000; border-color: #fff; }

    </style>
  </head>
  <body>
    <!-- Top Stats / Header -->
    <div style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 900; font-size: 1.2rem; letter-spacing: -1px;">KOLOAU <span style="color:var(--tg-accent)">MAX</span></span>
        <div id="status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #2ecc71; box-shadow: 0 0 10px #2ecc71;"></div>
    </div>

    <!-- Mode 1: AI STUDIO (Chat) -->
    <div id="mode-studio" class="mode-container active">
        <div class="model-scroller" id="model-scroller-chat">
            <!-- Models populated by JS -->
        </div>

        <div class="chat-container glass-box">
            <div class="chat-messages" id="chat-messages">
                <div class="bubble ai">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò —Ö–∞–±. –í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å —Å–≤–µ—Ä—Ö—É –∏ –∑–∞–¥–∞–π –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å. üîã</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="–°–ø—Ä–æ—Å–∏ –æ —á–µ–º —É–≥–æ–¥–Ω–æ..." onkeypress="handleChatKey(event)">
                <button onclick="sendChatMessage()" style="width: 45px; height: 45px; border-radius: 50%; padding: 0; margin: 0;">üöÄ</button>
            </div>
        </div>
    </div>

    <!-- Mode 2: BOT FACTORY (Builder) -->
    <div id="mode-factory" class="mode-container">
        <section class="glass-box">
            <h2>üõ† –°–±–æ—Ä–∫–∞ –ê–≥–µ–Ω—Ç–∞</h2>
            <div class="input-group">
                <label>TOKEN BOTFATHER</label>
                <input type="text" id="token" placeholder="–ü–æ–ª—É—á–∏ –≤ @BotFather">
            </div>
            <div class="input-group">
                <label>–í–´–ë–ï–†–ò –ú–û–¢–û–†</label>
                <div class="model-scroller" id="model-scroller-builder"></div>
                <input type="hidden" id="builder-model" value="gpt-5.2-pro">
            </div>
            <div class="input-group">
                <label>–ò–ù–°–¢–†–£–ö–¶–ò–ò (–†–û–õ–¨)</label>
                <textarea id="instructions" placeholder="–¢—ã ‚Äî –ª—É—á—à–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç..."></textarea>
            </div>
            <button class="main-btn" onclick="createBot()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ê–≥–µ–Ω—Ç–∞</button>
        </section>

        <section id="fleet-section">
            <h2>üîã –¢–≤–æ–π –§–ª–æ—Ç</h2>
            <div id="bot-list">
                <div style="opacity:0.3; text-align:center; padding: 20px;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
            </div>
        </section>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-tab active" onclick="switchMode('studio', this)">
            <span>üí¨</span>
            <label>–°—Ç—É–¥–∏—è</label>
        </div>
        <div class="nav-tab" onclick="switchMode('factory', this)">
            <span>üõ†</span>
            <label>–ó–∞–≤–æ–¥</label>
        </div>
    </nav>

    <script>
      const tg = window.Telegram.WebApp;
      tg.expand();
      tg.ready();

      let modelsData = {};
      let selectedChatModel = 'gpt-5.2-pro';
      let selectedBuilderModel = 'gpt-5.2-pro';
      let chatHistory = [];

      async function init() {
          const res = await fetch('/api/models');
          modelsData = await res.json();
          renderModelScrollers();
          fetchBots();
          
          // Theme sync
          document.body.style.backgroundColor = tg.backgroundColor;
          document.body.style.color = tg.textColor;
      }

      function switchMode(mode, el) {
          if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
          document.querySelectorAll('.mode-container').forEach(m => m.classList.remove('active'));
          document.getElementById(`mode-${mode}`).classList.add('active');
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          el.classList.add('active');
      }

      function renderModelScrollers() {
          const chatScroller = document.getElementById('model-scroller-chat');
          const buildScroller = document.getElementById('model-scroller-builder');
          
          let html = '';
          Object.keys(modelsData).forEach(cat => {
              Object.keys(modelsData[cat].models).forEach(id => {
                  html += `<div class="m-chip ${selectedChatModel === id ? 'active' : ''}" data-id="${id}" onclick="selectModel('${id}', this)">${modelsData[cat].models[id]}</div>`;
              });
          });
          
          chatScroller.innerHTML = html;
          buildScroller.innerHTML = html; // Simple reuse for now
      }

      function selectModel(id, el) {
          if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
          const parent = el.parentElement;
          parent.querySelectorAll('.m-chip').forEach(c => c.classList.remove('active'));
          el.classList.add('active');
          
          if (parent.id === 'model-scroller-chat') selectedChatModel = id;
          else {
              selectedBuilderModel = id;
              document.getElementById('builder-model').value = id;
          }
      }

      // Chat Logic
      function handleChatKey(e) { if(e.key === 'Enter') sendChatMessage(); }

      async function sendChatMessage() {
          const input = document.getElementById('chat-input');
          const msg = input.value.trim();
          if (!msg) return;

          if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
          
          appendMessage('user', msg);
          input.value = '';
          
          try {
              const res = await fetch('/api/chat', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ message: msg, model: selectedChatModel, chatHistory })
              });
              const data = await res.json();
              if (data.success) {
                  appendMessage('ai', data.response);
                  chatHistory.push({ role: 'user', content: msg });
                  chatHistory.push({ role: 'assistant', content: data.response });
              } else {
                  appendMessage('ai', '–û—à–∏–±–∫–∞ –¥–≤–∏–∂–∫–∞: ' + data.message);
              }
          } catch(e) { appendMessage('ai', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.'); }
      }

      function appendMessage(role, text) {
          const container = document.getElementById('chat-messages');
          const div = document.createElement('div');
          div.className = `bubble ${role}`;
          div.innerText = text;
          container.appendChild(div);
          container.scrollTop = container.scrollHeight;
      }

      // Builder Logic
      async function createBot() {
          const token = document.getElementById('token').value;
          const instructions = document.getElementById('instructions').value;
          if (!token || !instructions) return tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!');

          if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
          
          try {
            const res = await fetch("/api/bots/create", { 
                method: "POST", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify({ token, model: selectedBuilderModel, instructions }) 
            });
            const result = await res.json();
            if (result.success) {
                tg.showAlert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤–æ —Ñ–ª–æ—Ç–µ!');
                fetchBots();
            } else tg.showAlert('–û—à–∏–±–∫–∞: ' + result.message);
          } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º'); }
      }

      async function fetchBots() {
          const res = await fetch('/api/bots/list');
          const data = await res.json();
          const container = document.getElementById('bot-list');
          
          if (data.bots.length === 0) {
              container.innerHTML = '<div style="opacity:0.3; text-align:center;">–§–ª–æ—Ç –ø—É—Å—Ç.</div>';
              return;
          }

          container.innerHTML = data.bots.map(b => `
              <div class="bot-card-mini">
                  <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: 800; font-size: 0.8rem;">${b.token.substring(0, 10)}...</div>
                    <span class="badge" style="background: ${b.is_active ? '#2ecc71' : '#ff4757'}">${b.is_active ? 'LIVE' : 'OFF'}</span>
                  </div>
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <button class="main-btn" style="padding: 8px; font-size: 0.6rem;" onclick="toggleBot('${b.token}')">${b.is_active ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫'}</button>
                    <button class="main-btn" style="padding: 8px; font-size: 0.6rem; background: rgba(231, 76, 60, 0.2); color: #e74c3c;" onclick="deleteBot('${b.token}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
                  </div>
              </div>
          `).join('');
      }

      async function toggleBot(token) {
          await fetch('/api/bots/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) });
          fetchBots();
      }

      async function deleteBot(token) {
          if (confirm('–£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞?')) {
              await fetch('/api/bots/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) });
              fetchBots();
          }
      }

      init();
      setInterval(fetchBots, 20000);
    </script>
  </body>
</html>
